use serde::Deserialize;
use serde_value::{Value, ValueDeserializer};
use slab_mmap::Slab;
use std::collections::BTreeMap;

#[derive(Clone, Copy, Debug)]
enum Op {
    Insert(i32),
    RemoveKeyIdx(usize),
    RemoveRaw(usize),
    Checkpoint,
}

// Auto-generated to exercise serde bridges across a large patterned sequence.
const OPS: &[Op] = &[
    Op::Insert(0),
    Op::Insert(17),
    Op::Insert(34),
    Op::Insert(51),
    Op::Insert(68),
    Op::Insert(85),
    Op::Insert(102),
    Op::Insert(119),
    Op::Insert(136),
    Op::Insert(153),
    Op::Insert(170),
    Op::Insert(187),
    Op::Insert(204),
    Op::Insert(221),
    Op::Insert(238),
    Op::Insert(255),
    Op::Insert(272),
    Op::Insert(289),
    Op::Insert(306),
    Op::Insert(323),
    Op::Insert(340),
    Op::Insert(357),
    Op::Insert(374),
    Op::Insert(391),
    Op::Insert(408),
    Op::Insert(425),
    Op::Insert(442),
    Op::Insert(459),
    Op::Insert(476),
    Op::Insert(493),
    Op::Insert(510),
    Op::Insert(527),
    Op::Insert(544),
    Op::Insert(561),
    Op::Insert(578),
    Op::Insert(595),
    Op::Insert(612),
    Op::Insert(629),
    Op::Insert(646),
    Op::Insert(663),
    Op::Insert(680),
    Op::Insert(697),
    Op::Insert(714),
    Op::Insert(731),
    Op::Insert(748),
    Op::Insert(765),
    Op::Insert(782),
    Op::Insert(799),
    Op::Insert(816),
    Op::Insert(833),
    Op::Insert(2345),
    Op::Insert(2371),
    Op::RemoveRaw(799),
    Op::Insert(2324),
    Op::Insert(2053),
    Op::Checkpoint,
    Op::RemoveKeyIdx(2),
    Op::RemoveKeyIdx(11),
    Op::Insert(2311),
    Op::Insert(2711),
    Op::Insert(2330),
    Op::RemoveKeyIdx(9),
    Op::Insert(2701),
    Op::RemoveRaw(875),
    Op::RemoveRaw(873),
    Op::Insert(2911),
    Op::RemoveKeyIdx(7),
    Op::Insert(2743),
    Op::Checkpoint,
    Op::Insert(2641),
    Op::Insert(2645),
    Op::RemoveRaw(943),
    Op::Insert(2983),
    Op::Checkpoint,
    Op::Insert(3145),
    Op::Insert(2885),
    Op::Insert(3131),
    Op::Insert(2981),
    Op::Insert(3414),
    Op::Insert(3308),
    Op::RemoveKeyIdx(58),
    Op::RemoveRaw(972),
    Op::Insert(3540),
    Op::Insert(3291),
    Op::Insert(3625),
    Op::Insert(3640),
    Op::Insert(3468),
    Op::RemoveRaw(1030),
    Op::Insert(3630),
    Op::RemoveRaw(1068),
    Op::RemoveRaw(1059),
    Op::RemoveRaw(1029),
    Op::Insert(3503),
    Op::RemoveRaw(1004),
    Op::RemoveRaw(1037),
    Op::Insert(3746),
    Op::RemoveKeyIdx(68),
    Op::Checkpoint,
    Op::Insert(3967),
    Op::Insert(3883),
    Op::RemoveKeyIdx(59),
    Op::Insert(4265),
    Op::Insert(4148),
    Op::RemoveRaw(1082),
    Op::RemoveRaw(1136),
    Op::RemoveKeyIdx(71),
    Op::Insert(4230),
    Op::RemoveRaw(1144),
    Op::Insert(4447),
    Op::Checkpoint,
    Op::Checkpoint,
    Op::Insert(4184),
    Op::Insert(4463),
    Op::Insert(4225),
    Op::Insert(4658),
    Op::Insert(4816),
    Op::Insert(4666),
    Op::Insert(4417),
    Op::Insert(4663),
    Op::RemoveKeyIdx(72),
    Op::Checkpoint,
    Op::Insert(4917),
    Op::Insert(4811),
    Op::RemoveRaw(1196),
    Op::RemoveKeyIdx(63),
    Op::Insert(5175),
    Op::RemoveRaw(1204),
    Op::RemoveKeyIdx(58),
    Op::Insert(4934),
    Op::Insert(5136),
    Op::Insert(4997),
    Op::Insert(5188),
    Op::Checkpoint,
    Op::RemoveKeyIdx(71),
    Op::RemoveKeyIdx(68),
    Op::Insert(5358),
    Op::Checkpoint,
    Op::RemoveKeyIdx(74),
    Op::Insert(5700),
    Op::RemoveKeyIdx(74),
    Op::Insert(5741),
    Op::Insert(5723),
    Op::Insert(5562),
    Op::Insert(5478),
    Op::RemoveKeyIdx(65),
    Op::RemoveKeyIdx(63),
    Op::Insert(5523),
    Op::Checkpoint,
    Op::Insert(5542),
    Op::Insert(5667),
    Op::Insert(5759),
    Op::RemoveRaw(1315),
    Op::Insert(5844),
    Op::RemoveRaw(1374),
    Op::Insert(6292),
    Op::RemoveRaw(1307),
    Op::Insert(5860),
    Op::Insert(6348),
    Op::Insert(6374),
    Op::RemoveRaw(1327),
    Op::RemoveKeyIdx(59),
    Op::RemoveKeyIdx(67),
    Op::Insert(6346),
    Op::RemoveKeyIdx(70),
    Op::Insert(6079),
    Op::RemoveRaw(1434),
    Op::Checkpoint,
    Op::Insert(6333),
    Op::RemoveRaw(1449),
    Op::RemoveKeyIdx(68),
    Op::Checkpoint,
    Op::Insert(6701),
    Op::Checkpoint,
    Op::RemoveRaw(1439),
    Op::Insert(6911),
    Op::Insert(6629),
    Op::Insert(6919),
    Op::RemoveKeyIdx(55),
    Op::Insert(6806),
    Op::RemoveKeyIdx(58),
    Op::Insert(6660),
    Op::Checkpoint,
    Op::Checkpoint,
    Op::Insert(7134),
    Op::RemoveKeyIdx(64),
    Op::Checkpoint,
    Op::Insert(7124),
    Op::RemoveKeyIdx(64),
    Op::Insert(7099),
    Op::RemoveRaw(1505),
    Op::Insert(7448),
    Op::RemoveRaw(1522),
    Op::RemoveKeyIdx(64),
    Op::RemoveRaw(1504),
    Op::Insert(7453),
    Op::Insert(7424),
    Op::Insert(7769),
    Op::Checkpoint,
    Op::Insert(7546),
    Op::RemoveKeyIdx(69),
    Op::Checkpoint,
    Op::RemoveKeyIdx(67),
    Op::Insert(7474),
    Op::RemoveRaw(1547),
    Op::Insert(7999),
    Op::RemoveKeyIdx(62),
    Op::Insert(7644),
    Op::Insert(7813),
    Op::Insert(8202),
    Op::Insert(8162),
    Op::Insert(8100),
    Op::Insert(7884),
    Op::Insert(8174),
    Op::RemoveKeyIdx(72),
    Op::Insert(8028),
    Op::Insert(8065),
    Op::Checkpoint,
    Op::RemoveKeyIdx(62),
    Op::Insert(8154),
    Op::Checkpoint,
    Op::RemoveKeyIdx(68),
    Op::Checkpoint,
    Op::Insert(8390),
    Op::Insert(8427),
    Op::RemoveRaw(1708),
    Op::RemoveKeyIdx(60),
    Op::RemoveKeyIdx(70),
    Op::Insert(8630),
    Op::Insert(8799),
    Op::RemoveKeyIdx(67),
    Op::RemoveRaw(1689),
    Op::Insert(9141),
    Op::Insert(8881),
    Op::RemoveKeyIdx(69),
    Op::Checkpoint,
    Op::Checkpoint,
    Op::RemoveRaw(1796),
    Op::Insert(9044),
    Op::Checkpoint,
    Op::Insert(9272),
    Op::Insert(9441),
    Op::RemoveRaw(1800),
    Op::RemoveRaw(1791),
    Op::Insert(9508),
    Op::RemoveKeyIdx(56),
    Op::RemoveKeyIdx(66),
    Op::RemoveKeyIdx(57),
    Op::Insert(9304),
    Op::Insert(9517),
    Op::Insert(9521),
    Op::Insert(9338),
    Op::Insert(9760),
    Op::Insert(9346),
    Op::RemoveRaw(1790),
    Op::RemoveKeyIdx(70),
    Op::Insert(9754),
    Op::RemoveRaw(1805),
    Op::Insert(9817),
    Op::Insert(9546),
    Op::Insert(9682),
    Op::Checkpoint,
    Op::RemoveRaw(1865),
    Op::Insert(9771),
    Op::Insert(10050),
    Op::Insert(9856),
    Op::Insert(9849),
    Op::Insert(10304),
    Op::Insert(9978),
    Op::RemoveKeyIdx(65),
    Op::Insert(10283),
    Op::Insert(10375),
    Op::RemoveRaw(1950),
    Op::RemoveKeyIdx(62),
    Op::Insert(10398),
    Op::RemoveKeyIdx(69),
    Op::Insert(10351),
    Op::Checkpoint,
    Op::RemoveKeyIdx(73),
    Op::RemoveKeyIdx(73),
    Op::RemoveKeyIdx(60),
    Op::Insert(10701),
    Op::RemoveKeyIdx(60),
    Op::Insert(11006),
    Op::Insert(10735),
    Op::Insert(10640),
    Op::Insert(10677),
    Op::RemoveRaw(2018),
    Op::RemoveKeyIdx(55),
    Op::Insert(11151),
    Op::Insert(11287),
    Op::Insert(11302),
    Op::RemoveKeyIdx(59),
    Op::Checkpoint,
    Op::Insert(10907),
    Op::RemoveRaw(24),
    Op::RemoveRaw(8),
    Op::RemoveRaw(6),
    Op::Insert(11121),
    Op::Insert(11103),
    Op::Insert(11624),
    Op::Checkpoint,
    Op::Insert(11610),
    Op::Insert(11317),
    Op::Insert(11552),
    Op::Insert(11512),
    Op::Insert(11549),
    Op::RemoveKeyIdx(68),
    Op::RemoveKeyIdx(57),
    Op::Insert(11583),
    Op::Insert(12027),
    Op::Insert(11723),
    Op::Insert(11892),
    Op::RemoveKeyIdx(59),
    Op::Insert(11922),
    Op::Insert(11717),
    Op::RemoveKeyIdx(56),
    Op::RemoveKeyIdx(70),
    Op::Insert(11861),
    Op::Insert(11832),
    Op::RemoveRaw(128),
    Op::RemoveKeyIdx(69),
    Op::Insert(11888),
    Op::Insert(12035),
    Op::Checkpoint,
    Op::Insert(12318),
    Op::Insert(12256),
    Op::Insert(12634),
    Op::RemoveKeyIdx(62),
    Op::RemoveKeyIdx(61),
    Op::Insert(12470),
    Op::Insert(12771),
    Op::Insert(12324),
    Op::Insert(12515),
    Op::Insert(12849),
    Op::Insert(12358),
    Op::Insert(12934),
    Op::Insert(12795),
    Op::RemoveKeyIdx(58),
    Op::Insert(12902),
    Op::Insert(13137),
    Op::RemoveRaw(275),
    Op::Checkpoint,
    Op::RemoveKeyIdx(71),
    Op::RemoveRaw(255),
    Op::Checkpoint,
    Op::RemoveKeyIdx(62),
    Op::Insert(13011),
    Op::Insert(13103),
    Op::Insert(13283),
    Op::Insert(13210),
    Op::Insert(13027),
    Op::RemoveKeyIdx(74),
    Op::Checkpoint,
    Op::RemoveKeyIdx(69),
    Op::Insert(13175),
    Op::Checkpoint,
    Op::Insert(13612),
    Op::Insert(13286),
    Op::Insert(13312),
    Op::RemoveKeyIdx(74),
    Op::RemoveKeyIdx(61),
    Op::RemoveKeyIdx(64),
    Op::RemoveKeyIdx(67),
    Op::Insert(13651),
    Op::Insert(13545),
    Op::RemoveKeyIdx(65),
    Op::Insert(13652),
    Op::Insert(13832),
    Op::Insert(13704),
    Op::RemoveRaw(329),
    Op::Insert(13778),
    Op::RemoveRaw(409),
    Op::Insert(14094),
    Op::Insert(14362),
    Op::Insert(14003),
    Op::RemoveKeyIdx(72),
    Op::Insert(14253),
    Op::RemoveKeyIdx(74),
    Op::RemoveRaw(374),
    Op::Insert(14078),
    Op::RemoveRaw(405),
    Op::Insert(14207),
    Op::Insert(14717),
    Op::RemoveRaw(455),
    Op::RemoveKeyIdx(74),
    Op::RemoveKeyIdx(72),
    Op::RemoveKeyIdx(66),
    Op::Insert(14759),
    Op::Insert(14719),
    Op::Insert(14679),
    Op::RemoveRaw(497),
    Op::Checkpoint,
    Op::Insert(14944),
    Op::Insert(14871),
    Op::Insert(14941),
    Op::Insert(15165),
    Op::Insert(14828),
    Op::RemoveRaw(532),
    Op::RemoveRaw(516),
    Op::Insert(15181),
    Op::RemoveKeyIdx(58),
    Op::Insert(15277),
    Op::Checkpoint,
    Op::Insert(15010),
    Op::Insert(14959),
    Op::RemoveKeyIdx(58),
    Op::RemoveRaw(535),
    Op::RemoveKeyIdx(72),
    Op::Insert(15228),
    Op::Insert(15232),
    Op::RemoveKeyIdx(68),
    Op::Insert(15504),
    Op::RemoveKeyIdx(64),
    Op::Insert(15644),
    Op::Insert(15494),
    Op::Insert(15839),
    Op::Insert(15480),
    Op::Insert(15770),
    Op::Insert(15983),
    Op::Insert(15899),
    Op::Insert(15760),
    Op::RemoveKeyIdx(56),
    Op::RemoveKeyIdx(69),
    Op::Checkpoint,
    Op::Insert(16106),
    Op::RemoveRaw(623),
    Op::RemoveRaw(663),
    Op::RemoveKeyIdx(67),
    Op::Insert(15847),
    Op::RemoveRaw(692),
    Op::RemoveKeyIdx(70),
    Op::Insert(16365),
    Op::RemoveRaw(700),
    Op::Insert(16164),
    Op::Insert(16245),
    Op::Insert(16458),
    Op::Insert(16286),
    Op::Insert(16312),
    Op::Checkpoint,
    Op::RemoveKeyIdx(70),
    Op::Insert(16489),
    Op::Insert(16691),
    Op::Insert(16750),
    Op::RemoveRaw(706),
    Op::Insert(16714),
    Op::Checkpoint,
    Op::Insert(16975),
    Op::Insert(16825),
    Op::RemoveRaw(801),
    Op::RemoveRaw(764),
    Op::Insert(17013),
    Op::RemoveKeyIdx(64),
    Op::RemoveKeyIdx(62),
    Op::Insert(17113),
    Op::Insert(16864),
    Op::Insert(16956),
    Op::RemoveRaw(799),
    Op::Insert(17503),
    Op::Insert(17331),
    Op::Insert(17038),
    Op::Insert(17020),
    Op::Insert(17519),
    Op::Checkpoint,
    Op::Insert(17307),
    Op::RemoveRaw(839),
    Op::Insert(17568),
    Op::Insert(17462),
    Op::Checkpoint,
    Op::RemoveKeyIdx(56),
    Op::RemoveKeyIdx(70),
    Op::Checkpoint,
    Op::Insert(18021),
    Op::RemoveKeyIdx(71),
    Op::Insert(17512),
    Op::Insert(17692),
    Op::Insert(17674),
    Op::RemoveRaw(948),
    Op::Insert(17858),
    Op::RemoveKeyIdx(69),
    Op::Insert(17767),
    Op::Insert(18277),
    Op::RemoveKeyIdx(74),
    Op::RemoveKeyIdx(70),
    Op::Insert(18069),
    Op::RemoveKeyIdx(55),
    Op::Insert(18121),
    Op::Insert(18037),
    Op::Insert(18448),
    Op::Insert(18562),
    Op::Insert(18148),
    Op::Insert(18625),
    Op::Insert(18453),
    Op::RemoveRaw(1021),
    Op::Insert(18582),
    Op::RemoveRaw(1017),
    Op::Insert(18458),
    Op::Insert(18847),
    Op::Checkpoint,
    Op::RemoveKeyIdx(71),
    Op::Insert(19035),
    Op::RemoveRaw(1005),
    Op::Checkpoint,
    Op::Insert(18783),
    Op::Insert(18941),
    Op::Insert(18868),
    Op::Insert(18927),
    Op::Insert(19294),
    Op::Insert(18792),
    Op::Insert(19038),
    Op::Checkpoint,
    Op::Insert(19332),
    Op::Insert(19479),
    Op::RemoveRaw(1107),
    Op::Checkpoint,
    Op::Insert(19359),
    Op::Insert(19429),
    Op::Insert(19312),
    Op::RemoveRaw(1160),
    Op::Insert(19309),
    Op::Insert(19731),
    Op::Insert(19284),
    Op::RemoveKeyIdx(60),
    Op::Insert(19622),
    Op::Insert(19626),
    Op::RemoveKeyIdx(58),
    Op::Insert(19909),
    Op::Insert(19891),
    Op::Insert(19818),
    Op::Insert(19844),
    Op::Insert(19606),
    Op::RemoveRaw(1190),
    Op::Insert(19911),
    Op::Insert(20245),
    Op::Insert(20183),
    Op::Insert(20143),
    Op::Insert(19883),
    Op::Checkpoint,
    Op::Insert(20254),
    Op::Insert(20390),
    Op::RemoveRaw(1221),
    Op::RemoveKeyIdx(65),
    Op::Insert(20578),
    Op::RemoveRaw(1264),
    Op::RemoveKeyIdx(68),
    Op::Insert(20590),
    Op::Insert(20198),
    Op::Insert(20356),
    Op::Insert(20602),
    Op::Insert(20518),
    Op::RemoveKeyIdx(74),
    Op::Insert(20713),
    Op::Insert(20431),
    Op::Insert(20567),
    Op::RemoveRaw(1249),
    Op::RemoveKeyIdx(55),
    Op::Insert(21019),
    Op::Checkpoint,
    Op::Insert(21049),
    Op::RemoveKeyIdx(55),
    Op::RemoveRaw(1286),
    Op::RemoveKeyIdx(65),
    Op::Insert(20911),
    Op::Insert(21333),
    Op::RemoveKeyIdx(73),
    Op::Insert(21132),
    Op::Insert(21257),
    Op::Insert(20997),
    Op::Checkpoint,
    Op::RemoveKeyIdx(55),
    Op::Insert(21053),
    Op::RemoveKeyIdx(66),
    Op::RemoveKeyIdx(68),
    Op::RemoveRaw(1421),
    Op::Checkpoint,
    Op::Checkpoint,
    Op::Checkpoint,
    Op::RemoveRaw(1427),
    Op::Insert(21624),
    Op::Insert(21892),
    Op::RemoveKeyIdx(55),
    Op::Insert(21548),
    Op::RemoveRaw(1452),
    Op::Insert(21996),
    Op::RemoveRaw(1420),
    Op::Insert(22048),
    Op::RemoveRaw(1465),
    Op::Insert(21847),
    Op::Checkpoint,
    Op::Insert(22174),
    Op::RemoveKeyIdx(64),
    Op::Insert(22259),
    Op::RemoveRaw(1502),
    Op::Insert(22476),
    Op::Insert(22392),
    Op::Insert(22539),
    Op::RemoveRaw(1550),
    Op::Insert(22459),
    Op::RemoveKeyIdx(70),
    Op::Insert(22302),
    Op::Insert(22427),
    Op::Insert(22783),
    Op::RemoveRaw(1552),
    Op::Insert(22802),
    Op::RemoveRaw(1569),
    Op::Checkpoint,
    Op::Insert(22627),
    Op::RemoveRaw(1528),
    Op::RemoveKeyIdx(72),
    Op::Insert(22914),
    Op::Insert(23094),
    Op::RemoveKeyIdx(70),
    Op::Insert(22607),
    Op::Insert(23062),
    Op::Insert(23077),
    Op::Insert(23004),
    Op::RemoveKeyIdx(55),
    Op::RemoveKeyIdx(74),
    Op::RemoveRaw(1576),
    Op::RemoveRaw(1623),
    Op::Insert(23354),
    Op::RemoveKeyIdx(59),
    Op::RemoveKeyIdx(56),
    Op::RemoveKeyIdx(56),
    Op::RemoveRaw(1669),
    Op::Insert(23385),
    Op::RemoveKeyIdx(65),
    Op::RemoveKeyIdx(60),
    Op::Checkpoint,
    Op::Insert(23467),
    Op::RemoveRaw(1685),
    Op::Insert(23420),
    Op::Insert(23743),
    Op::RemoveKeyIdx(65),
    Op::RemoveRaw(1705),
    Op::RemoveRaw(1689),
    Op::RemoveRaw(1680),
    Op::Insert(23994),
    Op::Insert(23690),
    Op::Checkpoint,
    Op::Insert(23973),
    Op::RemoveRaw(1754),
    Op::Insert(24146),
    Op::Insert(24062),
    Op::Insert(24066),
    Op::Insert(24026),
    Op::Insert(23898),
    Op::Insert(23957),
    Op::Insert(24280),
    Op::RemoveKeyIdx(60),
    Op::RemoveRaw(1743),
    Op::Checkpoint,
    Op::Insert(24186),
    Op::RemoveKeyIdx(58),
    Op::Insert(24744),
    Op::RemoveRaw(1782),
    Op::RemoveKeyIdx(73),
    Op::Insert(24536),
    Op::Checkpoint,
    Op::RemoveRaw(1865),
    Op::Insert(24922),
    Op::RemoveKeyIdx(63),
    Op::Insert(25018),
    Op::Insert(24835),
    Op::Insert(24729),
    Op::RemoveRaw(1853),
    Op::RemoveRaw(1893),
    Op::Insert(24642),
    Op::Checkpoint,
    Op::Checkpoint,
    Op::Insert(24896),
    Op::Checkpoint,
    Op::Insert(25421),
    Op::Insert(25172),
    Op::Insert(25143),
    Op::RemoveRaw(1945),
    Op::RemoveKeyIdx(66),
    Op::RemoveKeyIdx(59),
    Op::Insert(25115),
    Op::RemoveKeyIdx(71),
    Op::Insert(25464),
    Op::Insert(25325),
    Op::RemoveKeyIdx(58),
    Op::Insert(25421),
    Op::RemoveKeyIdx(59),
    Op::RemoveRaw(1967),
    Op::RemoveKeyIdx(67),
    Op::RemoveKeyIdx(71),
    Op::RemoveRaw(1919),
    Op::Insert(25896),
    Op::Checkpoint,
    Op::RemoveKeyIdx(56),
    Op::RemoveRaw(1953),
    Op::Checkpoint,
    Op::RemoveKeyIdx(64),
    Op::Insert(26272),
    Op::RemoveKeyIdx(70),
    Op::RemoveKeyIdx(57),
    Op::Insert(26009),
    Op::Checkpoint,
    Op::RemoveKeyIdx(60),
    Op::RemoveKeyIdx(57),
    Op::Insert(26300),
    Op::Checkpoint,
    Op::Insert(26352),
    Op::RemoveRaw(2039),
    Op::Insert(26470),
    Op::Checkpoint,
    Op::Checkpoint,
    Op::RemoveKeyIdx(66),
    Op::RemoveKeyIdx(62),
    Op::RemoveRaw(14),
    Op::Insert(26637),
    Op::Insert(26729),
    Op::RemoveKeyIdx(56),
    Op::Insert(26517),
    Op::Checkpoint,
    Op::Insert(26888),
    Op::Insert(26859),
    Op::Insert(26940),
    Op::Insert(27065),
    Op::Insert(27080),
    Op::RemoveKeyIdx(69),
    Op::Insert(26824),
    Op::Insert(26938),
    Op::Insert(26997),
    Op::Insert(27144),
    Op::Insert(27401),
    Op::RemoveRaw(155),
    Op::Insert(27145),
    Op::Checkpoint,
    Op::Insert(27307),
    Op::Insert(27135),
    Op::Insert(27667),
    Op::Insert(27693),
    Op::Insert(27620),
    Op::RemoveKeyIdx(69),
    Op::RemoveKeyIdx(59),
    Op::Insert(27852),
    Op::Insert(27383),
    Op::Insert(27629),
    Op::Insert(27963),
    Op::Insert(27956),
    Op::Checkpoint,
    Op::RemoveKeyIdx(74),
    Op::RemoveRaw(247),
    Op::Insert(27587),
    Op::Checkpoint,
    Op::RemoveKeyIdx(73),
    Op::Insert(28204),
    Op::RemoveKeyIdx(61),
    Op::Insert(27750),
    Op::Insert(28282),
    Op::Insert(28242),
    Op::Checkpoint,
    Op::Insert(28437),
    Op::Insert(28518),
    Op::RemoveKeyIdx(68),
    Op::Checkpoint,
    Op::Checkpoint,
    Op::RemoveKeyIdx(69),
    Op::RemoveRaw(243),
    Op::Insert(28465),
    Op::RemoveKeyIdx(62),
    Op::Insert(28539),
    Op::Insert(28642),
    Op::RemoveKeyIdx(55),
    Op::RemoveKeyIdx(62),
    Op::Insert(28412),
    Op::Insert(28955),
    Op::Insert(28926),
    Op::RemoveRaw(349),
    Op::RemoveRaw(361),
    Op::Insert(29125),
    Op::Checkpoint,
    Op::Insert(28869),
    Op::RemoveKeyIdx(59),
    Op::Insert(28888),
    Op::RemoveRaw(342),
    Op::RemoveKeyIdx(68),
    Op::Insert(28856),
    Op::Insert(29410),
    Op::RemoveRaw(334),
    Op::RemoveKeyIdx(72),
    Op::RemoveRaw(407),
    Op::Insert(29041),
    Op::Insert(29155),
    Op::RemoveRaw(408),
    Op::Insert(29713),
    Op::Insert(29343),
    Op::RemoveKeyIdx(59),
    Op::Insert(29483),
    Op::Insert(29333),
    Op::Insert(29667),
    Op::Insert(29869),
    Op::Insert(29829),
    Op::Insert(29712),
    Op::RemoveKeyIdx(58),
    Op::Insert(29940),
    Op::Insert(29999),
    Op::Checkpoint,
    Op::Insert(30128),
    Op::Insert(30022),
    Op::Checkpoint,
    Op::Insert(30294),
    Op::Insert(30100),
    Op::Insert(29895),
    Op::RemoveKeyIdx(60),
    Op::Insert(29881),
    Op::Checkpoint,
    Op::RemoveKeyIdx(69),
    Op::Insert(30036),
    Op::Insert(30491),
    Op::Insert(30352),
    Op::RemoveRaw(550),
    Op::Insert(30206),
    Op::Checkpoint,
    Op::RemoveRaw(565),
    Op::Insert(30284),
    Op::Checkpoint,
    Op::Insert(30336),
    Op::Insert(30681),
    Op::Insert(30652),
    Op::Insert(30436),
    Op::RemoveRaw(572),
    Op::Insert(30697),
    Op::Insert(30855),
    Op::Insert(30738),
    Op::RemoveKeyIdx(60),
    Op::RemoveRaw(639),
    Op::Insert(30827),
    Op::RemoveKeyIdx(72),
    Op::Insert(31044),
    Op::RemoveKeyIdx(59),
    Op::RemoveRaw(692),
    Op::Insert(31210),
    Op::Checkpoint,
    Op::Insert(31449),
    Op::Insert(31200),
    Op::RemoveRaw(633),
    Op::RemoveRaw(638),
    Op::Checkpoint,
    Op::Checkpoint,
    Op::Insert(31308),
    Op::Checkpoint,
    Op::Insert(31448),
    Op::Insert(31694),
    Op::Insert(31445),
    Op::RemoveKeyIdx(74),
    Op::Insert(31409),
    Op::Insert(31842),
    Op::RemoveKeyIdx(73),
    Op::RemoveRaw(761),
    Op::Insert(32052),
    Op::Insert(32111),
    Op::Checkpoint,
    Op::Insert(31910),
    Op::Insert(31771),
    Op::RemoveRaw(714),
    Op::RemoveRaw(810),
    Op::RemoveRaw(759),
    Op::Insert(32161),
    Op::Insert(32000),
    Op::RemoveRaw(837),
    Op::Checkpoint,
    Op::Insert(32386),
    Op::RemoveRaw(838),
    Op::RemoveRaw(766),
    Op::Insert(32244),
    Op::RemoveKeyIdx(72),
    Op::Insert(32208),
    Op::Insert(32674),
    Op::RemoveKeyIdx(68),
    Op::Insert(32858),
    Op::RemoveRaw(857),
    Op::Insert(32855),
    Op::Insert(32463),
    Op::RemoveKeyIdx(64),
    Op::RemoveRaw(863),
    Op::Insert(32959),
    Op::Insert(32534),
    Op::Insert(33143),
    Op::RemoveKeyIdx(62),
    Op::Insert(32777),
    Op::RemoveKeyIdx(55),
    Op::Insert(33214),
    Op::RemoveRaw(896),
    Op::RemoveKeyIdx(58),
    Op::Checkpoint,
    Op::Insert(33065),
    Op::RemoveKeyIdx(55),
    Op::Insert(33172),
    Op::Checkpoint,
    Op::RemoveKeyIdx(66),
    Op::RemoveRaw(950),
    Op::Insert(33452),
    Op::RemoveRaw(925),
    Op::RemoveKeyIdx(68),
    Op::Checkpoint,
    Op::RemoveKeyIdx(61),
    Op::RemoveKeyIdx(59),
    Op::RemoveKeyIdx(55),
    Op::Checkpoint,
    Op::RemoveRaw(939),
    Op::Insert(33785),
    Op::Insert(33899),
    Op::Insert(33826),
    Op::Insert(33643),
    Op::Insert(33944),
    Op::RemoveKeyIdx(57),
    Op::Insert(33974),
    Op::Checkpoint,
    Op::RemoveKeyIdx(59),
    Op::RemoveKeyIdx(72),
    Op::RemoveRaw(1015),
    Op::RemoveRaw(1069),
    Op::Insert(34383),
    Op::Insert(34365),
    Op::Insert(33962),
    Op::RemoveKeyIdx(63),
    Op::Insert(34454),
    Op::Insert(34293),
    Op::RemoveKeyIdx(62),
    Op::Insert(34411),
    Op::Insert(34646),
    Op::Insert(34551),
    Op::Insert(34698),
    Op::Insert(34647),
    Op::RemoveRaw(1071),
    Op::RemoveRaw(1167),
    Op::Insert(34758),
    Op::RemoveKeyIdx(71),
    Op::Insert(34458),
    Op::RemoveKeyIdx(66),
    Op::Insert(34785),
    Op::Insert(34668),
    Op::Insert(34925),
    Op::Checkpoint,
    Op::Insert(35241),
    Op::RemoveKeyIdx(62),
    Op::RemoveKeyIdx(71),
    Op::Checkpoint,
    Op::Insert(35147),
    Op::RemoveRaw(1230),
    Op::RemoveKeyIdx(60),
    Op::RemoveRaw(1198),
    Op::Checkpoint,
    Op::RemoveKeyIdx(62),
    Op::RemoveKeyIdx(57),
    Op::Insert(35098),
    Op::Insert(35234),
    Op::Insert(35557),
    Op::Insert(35495),
    Op::Insert(35785),
    Op::RemoveRaw(1285),
    Op::Insert(35639),
    Op::Insert(35764),
    Op::RemoveRaw(1272),
    Op::RemoveKeyIdx(74),
    Op::Insert(35963),
    Op::RemoveKeyIdx(60),
    Op::RemoveKeyIdx(70),
    Op::RemoveKeyIdx(67),
    Op::Insert(36078),
    Op::Insert(36225),
    Op::Checkpoint,
    Op::RemoveKeyIdx(70),
    Op::Insert(36204),
    Op::Insert(36274),
    Op::RemoveRaw(1367),
    Op::RemoveKeyIdx(58),
    Op::Insert(36264),
    Op::Insert(36356),
    Op::Insert(36316),
    Op::Insert(36320),
    Op::Insert(36203),
    Op::Checkpoint,
    Op::Insert(36376),
    Op::Insert(36589),
    Op::Insert(36351),
    Op::Checkpoint,
    Op::RemoveKeyIdx(68),
    Op::Checkpoint,
    Op::RemoveRaw(1430),
    Op::Insert(36624),
    Op::Insert(36672),
    Op::Insert(36742),
    Op::Checkpoint,
    Op::RemoveKeyIdx(61),
    Op::Insert(36941),
    Op::Checkpoint,
    Op::RemoveRaw(1379),
    Op::Checkpoint,
    Op::RemoveKeyIdx(67),
    Op::RemoveRaw(1401),
    Op::Insert(37174),
    Op::Insert(36947),
    Op::Insert(37116),
    Op::Insert(37296),
    Op::Insert(37245),
    Op::Insert(37469),
    Op::Insert(37242),
    Op::Insert(37455),
    Op::Insert(37085),
    Op::Checkpoint,
    Op::RemoveKeyIdx(68),
    Op::Insert(37361),
    Op::Insert(37607),
    Op::Insert(37314),
    Op::Insert(37362),
    Op::RemoveKeyIdx(70),
    Op::Insert(37777),
    Op::RemoveRaw(1582),
    Op::Insert(37620),
    Op::RemoveRaw(1536),
    Op::Checkpoint,
    Op::RemoveKeyIdx(62),
    Op::Insert(37735),
    Op::Insert(37640),
    Op::RemoveKeyIdx(73),
    Op::Insert(38099),
    Op::RemoveKeyIdx(60),
    Op::RemoveKeyIdx(61),
    Op::RemoveKeyIdx(56),
    Op::Insert(38324),
    Op::Insert(38141),
    Op::Insert(37991),
    Op::Insert(38314),
    Op::RemoveKeyIdx(61),
    Op::Insert(38190),
    Op::Insert(38161),
    Op::Insert(38671),
    Op::RemoveKeyIdx(62),
    Op::Insert(38283),
    Op::RemoveKeyIdx(73),
    Op::RemoveRaw(1634),
    Op::RemoveRaw(1688),
    Op::Insert(38398),
    Op::Insert(38578),
    Op::Insert(38615),
    Op::RemoveKeyIdx(72),
    Op::Insert(38898),
    Op::Insert(38627),
    Op::Insert(38895),
    Op::Insert(38756),
    Op::RemoveKeyIdx(71),
    Op::Checkpoint,
    Op::Insert(39285),
    Op::RemoveRaw(1678),
    Op::RemoveRaw(1676),
    Op::RemoveRaw(1702),
    Op::Insert(39158),
    Op::Checkpoint,
    Op::RemoveKeyIdx(66),
    Op::Insert(39489),
    Op::RemoveKeyIdx(57),
    Op::RemoveKeyIdx(56),
    Op::Insert(39490),
    Op::RemoveRaw(1714),
    Op::Insert(39740),
    Op::Insert(39612),
    Op::RemoveKeyIdx(72),
    Op::RemoveRaw(1762),
    Op::Insert(39371),
    Op::RemoveRaw(1765),
    Op::Checkpoint,
    Op::Insert(39537),
    Op::Checkpoint,
    Op::Insert(39765),
    Op::RemoveRaw(1804),
    Op::Insert(39850),
    Op::Insert(39953),
    Op::RemoveRaw(1847),
    Op::Insert(39774),
    Op::Insert(39921),
    Op::Insert(40068),
    Op::Insert(40017),
    Op::RemoveKeyIdx(70),
    Op::Insert(39948),
    Op::Insert(40106),
    Op::Insert(39923),
    Op::Insert(40532),
    Op::RemoveKeyIdx(57),
    Op::RemoveRaw(1930),
    Op::RemoveRaw(1851),
    Op::RemoveKeyIdx(60),
    Op::Insert(40552),
    Op::Insert(40226),
    Op::Insert(40538),
    Op::Insert(40652),
    Op::Checkpoint,
    Op::Insert(40726),
    Op::RemoveRaw(1982),
    Op::RemoveKeyIdx(58),
    Op::Insert(40540),
    Op::RemoveRaw(1983),
    Op::Insert(40834),
    Op::Insert(40915),
    Op::RemoveRaw(1949),
    Op::RemoveRaw(1919),
    Op::RemoveRaw(1987),
    Op::Insert(40975),
    Op::Insert(41331),
    Op::Insert(40928),
    Op::RemoveKeyIdx(69),
    Op::Insert(41156),
    Op::RemoveRaw(2003),
    Op::Insert(41131),
    Op::Insert(41333),
    Op::Insert(41194),
    Op::Insert(41132),
    Op::Insert(41147),
    Op::Insert(41338),
    Op::Insert(41573),
    Op::RemoveRaw(2001),
    Op::Checkpoint,
    Op::RemoveKeyIdx(72),
    Op::Insert(41688),
    Op::RemoveKeyIdx(56),
    Op::Insert(41531),
    Op::RemoveKeyIdx(59),
    Op::RemoveRaw(72),
    Op::Insert(41895),
    Op::RemoveRaw(89),
    Op::Insert(42112),
    Op::Insert(41962),
    Op::RemoveKeyIdx(64),
    Op::RemoveKeyIdx(69),
    Op::RemoveKeyIdx(63),
    Op::RemoveKeyIdx(56),
    Op::Insert(41883),
    Op::RemoveRaw(38),
    Op::Insert(41902),
    Op::RemoveKeyIdx(55),
    Op::Checkpoint,
    Op::Insert(42409),
    Op::RemoveRaw(70),
    Op::Insert(42384),
    Op::Insert(42102),
    Op::Insert(42227),
    Op::Insert(42462),
    Op::RemoveRaw(158),
    Op::RemoveKeyIdx(73),
    Op::RemoveRaw(91),
    Op::Insert(42313),
    Op::Checkpoint,
    Op::RemoveRaw(183),
    Op::Insert(42776),
    Op::RemoveKeyIdx(73),
    Op::Insert(42531),
    Op::Checkpoint,
];

type StdSlab<T> = slab::Slab<T>;

type Canon = BTreeMap<u64, Value>;

fn numeric_map(map: &Canon) -> BTreeMap<u64, i32> {
    map.iter()
        .map(|(k, v)| {
            let n = match v {
                Value::I64(n) => *n as i32,
                Value::U64(n) => *n as i32,
                Value::I32(n) => *n,
                Value::U32(n) => *n as i32,
                other => panic!("unexpected value kind in map: {other:?}"),
            };
            (*k, n)
        })
        .collect()
}

fn canonical_bytes_from_map(map: &Canon) -> Vec<u8> {
    let len = map
        .keys()
        .copied()
        .max()
        .map(|m| m as usize + 1)
        .unwrap_or(0);
    let mut seq: Vec<Option<i32>> = vec![None; len];
    for (k, v) in map {
        let idx = *k as usize;
        let num = match v {
            Value::I64(n) => *n as i32,
            Value::U64(n) => *n as i32,
            Value::I32(n) => *n,
            Value::U32(n) => *n as i32,
            other => panic!("unexpected value kind in map: {other:?}"),
        };
        seq[idx] = Some(num);
    }
    postcard::to_allocvec(&seq).expect("encode postcard")
}

fn canonical_map_from_value(value: Value) -> Canon {
    match value {
        Value::Map(entries) => entries
            .into_iter()
            .map(|(k, v)| match k {
                Value::U64(i) => (i, v),
                Value::I64(i) => (i as u64, v),
                other => panic!("unexpected key: {other:?}"),
            })
            .collect(),
        Value::Seq(seq) => seq
            .into_iter()
            .enumerate()
            .filter_map(|(idx, entry)| match entry {
                Value::Option(Some(inner)) => Some((idx as u64, *inner)),
                Value::Option(None) => None,
                other => panic!("unexpected seq entry: {other:?}"),
            })
            .collect(),
        other => panic!("unexpected top-level: {other:?}"),
    }
}

fn map_to_value(map: &Canon) -> Value {
    Value::Map(
        map.iter()
            .map(|(k, v)| (Value::U64(*k), v.clone()))
            .collect(),
    )
}

fn apply_ops(ops: &[Op]) -> (Slab<i32>, StdSlab<i32>) {
    let mut mmap = Slab::new().unwrap();
    let mut std = StdSlab::new();
    let mut keys_m = Vec::new();
    let mut keys_s = Vec::new();

    for (step, op) in ops.iter().enumerate() {
        match *op {
            Op::Insert(v) => {
                let km = mmap.insert(v).unwrap();
                let ks = std.insert(v);
                keys_m.push(km);
                keys_s.push(ks);
            }
            Op::RemoveKeyIdx(raw_idx) => {
                if keys_m.is_empty() {
                    continue;
                }
                let idx = raw_idx % keys_m.len();
                let km = keys_m.swap_remove(idx);
                let ks = keys_s.swap_remove(idx);
                let rm_m = mmap.try_remove(km);
                let rm_s = std.try_remove(ks);
                assert_eq!(rm_m, rm_s, "step {step}: remove key idx mismatch");
            }
            Op::RemoveRaw(idx) => {
                let rm_m = mmap.try_remove(idx);
                let rm_s = std.try_remove(idx);
                assert_eq!(rm_m, rm_s, "step {step}: remove raw mismatch idx={idx}");
                if let Some(pos) = keys_m.iter().position(|&k| k == idx) {
                    keys_m.swap_remove(pos);
                }
                if let Some(pos) = keys_s.iter().position(|&k| k == idx) {
                    keys_s.swap_remove(pos);
                }
            }
            Op::Checkpoint => {
                let snap_m = canonical_map_from_value(serde_value::to_value(&mmap).unwrap());
                let snap_s = canonical_map_from_value(serde_value::to_value(&std).unwrap());
                assert_eq!(snap_m, snap_s, "step {step}: snapshot divergence");
            }
        }
    }
    (mmap, std)
}

fn decode_mmap_from_slab_map(map: &Canon) -> Slab<i32> {
    let map_value = map_to_value(map);
    Slab::deserialize(ValueDeserializer::<serde_value::DeserializerError>::new(
        map_value,
    ))
    .expect("decode mmap from map")
}

fn decode_std_from_mmap_map(map_value: Value) -> StdSlab<i32> {
    StdSlab::deserialize(ValueDeserializer::<serde_value::DeserializerError>::new(
        map_value,
    ))
    .expect("decode std from map value")
}

fn assert_bridge_equivalence(mmap: &Slab<i32>, std: &StdSlab<i32>) {
    let mmap_map = canonical_map_from_value(serde_value::to_value(mmap).unwrap());
    let std_map = canonical_map_from_value(serde_value::to_value(std).unwrap());
    assert_eq!(mmap_map, std_map, "final canonical maps mismatch");
    let mmap_nums = numeric_map(&mmap_map);
    let std_nums = numeric_map(&std_map);
    assert_eq!(mmap_nums, std_nums, "numeric canonical maps mismatch");

    // postcard canonical bytes (seq representation) must match
    let bytes_m = canonical_bytes_from_map(&mmap_map);
    let bytes_s = canonical_bytes_from_map(&std_map);
    assert_eq!(bytes_m, bytes_s, "postcard canonical bytes mismatch");
    // ensure bytes decode back to the same canonical map
    let decoded_seq: Vec<Option<i32>> =
        postcard::from_bytes(&bytes_m).expect("decode seq from bytes");
    let mut decoded_map: BTreeMap<u64, i32> = BTreeMap::new();
    for (idx, val) in decoded_seq.into_iter().enumerate() {
        if let Some(v) = val {
            decoded_map.insert(idx as u64, v);
        }
    }
    assert_eq!(decoded_map, mmap_nums, "decoded map diverged from original");

    let mmap_from_std = decode_mmap_from_slab_map(&std_map);
    let mmap_from_std_map =
        canonical_map_from_value(serde_value::to_value(&mmap_from_std).unwrap());
    assert_eq!(mmap_from_std_map, std_map, "map->mmap mismatch");

    let map_from_mmap = map_to_value(&mmap_map);
    let std_from_mmap = decode_std_from_mmap_map(map_from_mmap);
    let std_from_mmap_map =
        canonical_map_from_value(serde_value::to_value(&std_from_mmap).unwrap());
    assert_eq!(std_from_mmap_map, mmap_map, "map->std mismatch");
}

#[test]
fn serde_bridge_heavy_pattern_large_ops() {
    let (mmap, std) = apply_ops(OPS);
    assert_bridge_equivalence(&mmap, &std);
}

#[test]
fn serde_bridge_prefix_windows() {
    for window_size in [8usize, 32, 64, 128, 256, OPS.len()] {
        let (mmap, std) = apply_ops(&OPS[..window_size]);
        assert_bridge_equivalence(&mmap, &std);
    }
}

#[test]
fn serde_bridge_suffix_windows() {
    for start in [0usize, OPS.len() / 4, OPS.len() / 2, OPS.len() - 128] {
        let (mmap, std) = apply_ops(&OPS[start..]);
        assert_bridge_equivalence(&mmap, &std);
    }
}

#[test]
fn serde_bridge_chunked_restarts() {
    let mut cursor = 0;
    let mut mmap = Slab::new().unwrap();
    let mut std = StdSlab::new();
    while cursor < OPS.len() {
        let end = (cursor + 25).min(OPS.len());
        let (chunk_m, _chunk_s) = apply_ops(&OPS[cursor..end]);
        let chunk_map = canonical_map_from_value(serde_value::to_value(&chunk_m).unwrap());
        let map_value = map_to_value(&chunk_map);
        mmap = Slab::deserialize(ValueDeserializer::<serde_value::DeserializerError>::new(
            map_value.clone(),
        ))
        .expect("decode cumulative mmap");
        std = decode_std_from_mmap_map(map_value);
        cursor = end;
    }
    assert_bridge_equivalence(&mmap, &std);
}
